# Generated with `make gen`
concurrency:
  cancel-in-progress: "${{ github.ref != 'master' }}"
  group: "${{ github.workflow }}-${{ github.ref }}"
jobs:
  export:
    runs-on: "ubuntu-latest"
    steps:
      - uses: "actions/checkout@v4"
      - uses: "actions/checkout@v4"
        with:
          path: "_manifests"
          ref: "main"
      - uses: "./.github/actions/install-tanka"
      - run: "rm -rf manifests/*"
        working-directory: "_manifests"
      - id: "export"
        run: |
          tk export \
          --recursive \
          --format '{{ if env.metadata.labels.cluster_name }}{{ env.metadata.labels.cluster_name }}/{{ end }}{{ if .metadata.namespace }}{{.metadata.namespace}}{{ else }}_cluster{{ end }}/{{.kind}}-{{.metadata.name}}' \
          --merge-strategy=fail-on-conflicts \
          ../_manifests/manifests/ \
          environments/
          
          cd ../manifests
          if [[ -n $(git status --porcelain) ]]; then
              echo "changes found"
              echo "changes=true" >> $GITHUB_OUTPUT
          fi
        working-directory: "jsonnet"
      - env:
          PR: "${{ github.event.number }}"
        if: "${{ github.event_name == 'pull_request' }}"
        run: "git checkout -b pr-$PR"
        working-directory: "_manifests"
      - env:
          BUILD_LINK: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          GITHUB_BASE_REF: "${{ github.base_ref }}"
          GITHUB_EVENT: "${{ github.event_name }}"
          GIT_AUTHOR_EMAIL: "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
          GIT_AUTHOR_NAME: "${{ github.actor }}"
          GIT_COMMITTER_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
          GIT_COMMITTER_NAME: "github-actions[bot]"
        id: "commit"
        if: "${{ steps.export.outputs.changes == 'true' }}"
        run: |
          git add manifests/
          git commit -m "$(git log -C .. -1 --pretty=%B)
          
          --
          
          - Event: $GITHUB_EVENT
          - Branch: $GITHUB_BASE_REF
          - Build link: $BUILD_LINK
          "
          git log -1 --format=fuller
          git show HEAD
          git config --global push.autoSetupRemote true
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
        working-directory: "_manifests"
      - env:
          PR: "${{ github.event.number }}"
        if: "${{ github.event_name == 'pull_request' }}"
        run: "git push -u -f origin pr-$PR"
        working-directory: "_manifests"
      - if: "${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}"
        run: "git push"
        working-directory: "_manifests"
      - if: "${{ github.event_name == 'pull_request' }}"
        uses: "thollander/actions-comment-pull-request@v2"
        with:
          comment_tag: "${{ github.workflow }}-difflinks"
          message: |
            permalink: ${{ github.server_url }}/${{ github.repository }}/compare/${{ github.event.pull_request.base.sha }}...${{ steps.commit.outputs.sha }}
            relative: ${{ github.server_url }}/${{ github.repository }}/compare/main...pr-${{ github.event.number }}
          mode: "recreate"
"on":
  pull_request:
    paths:
      - "jsonnet/**"
      - ".github/**"
  push:
    branches:
      - "main"
    paths:
      - "jsonnet/**"
      - ".github/**"
permissions:
  contents: "write"
  pull-requests: "write"